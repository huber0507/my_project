#include "bsp_clk.h"
#include "bsp_delay.h"
#include "bsp_led.h"

/* 
 * 主程序入口
 * 功能：通过初始化硬件模块，实现LED0的周期性闪烁（500ms亮/500ms灭）
 * 特点：包含完整的错误检测，模块初始化顺序严格遵循依赖关系
 */
int main(void)
{
    int ret;  // 用于接收函数返回值，检测初始化是否成功

    /* 
     * 初始化阶段：严格按照「时钟→延时→外设」的顺序
     * 原因：所有外设依赖时钟，延时模块依赖时钟，需保证依赖项先初始化
     */
    
    // 1. 初始化系统时钟（使能LED、延时定时器等必需外设的时钟）
    clk_system_init();
    // （注：clk_system_init无返回值，因时钟初始化失败会直接导致系统无法运行）

    // 2. 初始化延时模块（基于GPT定时器，需在使用delay_ms前调用）
    delay_init();

    // 3. 初始化LED0（检查返回值，确保硬件配置成功）
    ret = led_init(LED0);
    if (ret != 0) {
        // 初始化失败：此处可通过死循环+LED常亮/灭提示错误（裸机常用调试方式）
        while (1) {
            // 若LED0初始化失败，尝试用其他方式提示（如蜂鸣器，此处简化为LED常亮）
            // （实际项目中可根据硬件资源设计错误提示逻辑）
        }
    }

    /* 
     * 主循环：实现LED闪烁业务逻辑
     * 采用翻转（toggle）方式，减少代码冗余
     */
    while (1) {
        // 翻转LED0状态（亮→灭 或 灭→亮）
        led_toggle(LED0);
        
        // 延时500ms（基于优化后的高精度定时器，误差≤1ms）
        delay_ms(500);
    }

    // 理论上不会执行到此处（裸机无OS调度，主循环不会退出）
    return 0;
}
    